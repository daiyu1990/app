<include file="Public:header"/>

<!-- begin #content -->
		<div id="content" class="content content_waring">	
			<h1 class="page-header page_warging">
			    	<a>人员管理 </a>》<a>组织列表</a>》<a>{$title}</a>
			    	<a onclick="javascript:history.go(-1);" class="organ_back">
			    		<i class="engin_back"></i>
    					<span class="engin_add_text">返回</span>
			    	</a>
			</h1>
			<!--总标题-->
			<div class="equip_head engin_head">
				{$title}
			</div>
			<!--基本信息-->
			<form name="form1" id="form1" method="post" enctype="multipart/form-data" action='{:U("Admin/Organization/".ACTION_NAME)}' >

			<div class="equip_info ">
				<div class="equip_title engin_title">
					<i class="equip_i"></i>
					<span>基本组织信息</span>
				</div>
				<div class="equip_infomation">
					<!--设备基本信息表格-->
						<div class="detail-body check_bd clearfix">
							<?php if(ACTION_NAME == 'organ_edit'): ?>
							<input type="hidden" name="id" id="id" value="{$info.id}">
							<?php endif; ?>

							<input type="hidden" name="do" value="save1">
								<ul class="check-infol">
									<li class="cheitm">
										<label class="ifro_item">
											<span class="info_man"><i class="required_fields">*</i>组织机构名称：</span>
											<input type="text" name="name" id="name" value="{$info.name}" class="check_inp" />
										</label>
									</li>
									<li class="cheitm">
										<label class="ifro_item">
											<span class="info_man"><i class="required_fields">*</i>组织机构简称：</span>
											<input type="text" id="jiancheng" name="jiancheng" value="{$info.jiancheng}" class="check_inp" />

										</label>
									</li>
									<li class="cheitm layui-form-item">
										<label class="ifro_item layui_itemt layui-form-label">
											<span class="info_man"><i class="required_fields">*</i>地区：</span>
										
										<div class="layui-input-inline layui_ele">
									      <select name="sheng_id" id="sheng" class="check_inp check_inplds" >
											  <option value=''>选择省份</option>
											  <?php foreach($sheng as $k=>$v){ ?>
											  <?php if($v['id'] == $info['sheng_id']): ?>
											  <option selected="selected" value="{$v['id']}">{$v['name']}</option>
											  <?php else: ?>
											  <option value="{$v['id']}">{$v['name']}</option>
											  <?php endif; ?>
											  <?php } ?>
									      </select>
									    </div>
									    <div class="layui-input-inline layui_ele">
									      <select name="shi_id" id="shi" class="check_inp check_inplds" >
											  <?php if(ACTION_NAME == 'organ_add'): ?>
											  <option value=''>请先选择省份</option>
											  <?php else: ?>
											  <?php foreach($shi as $k=>$v){ ?>
											  <?php if($v['id'] == $info['shi_id']): ?>
											  <option selected="selected" value="{$v['id']}">{$v['name']}</option>
											  <?php else: ?>
											  <option value="{$v['id']}">{$v['name']}</option>
											  <?php endif; ?>
											  <?php } ?>
											  <?php endif; ?>
									      </select>
									    </div>
									    </label>
									</li>

									<li class="cheitm">
										<label class="ifro_item">
											<span class="info_man"><i class="required_fields">*</i>联系人：</span>
											<input type="text" id="contact" name="contact" value="{$info.contact}" class="check_inp" />
										</label>
									</li>

									<li class="cheitm">
										<label class="ifro_item">
											<span class="info_man"><i class="required_fields">*</i>法人：</span>
											<input type="text" id="raren" name="faren" value="{$info.faren}" class="check_inp" />
										</label>
									</li>

									<li class="cheitm">
										<label class="ifro_item">
											<span class="info_man"><i class="required_fields">*</i>组织机构类别：</span>
											<select name="type"  class="check_inp" id="type" />
											<option value=''>选择类别</option>
											<?php foreach($type as $k=>$v){ ?>
											<?php if($v['val'] == $info['type']): ?>
											<option selected="selected" value="{$v['val']}">{$v['name']}</option>
											<?php else: ?>
											<option value="{$v['val']}">{$v['name']}</option>
											<?php endif; ?>
											<?php } ?>
											</select>
										</label>
									</li>
									<li class="cheitm">
										<label class="ifro_item">
											<span class="info_man">组织机构代码：</span>
											<input type="text" name="company_code" id="company_code" value="{$info.company_code}" class="check_inp" />
										</label>
									</li>
								</ul>
								<ul class="check-infol">
									<li class="cheitm">
										<label class="ifro_item id_relative">
											<span class="info_man"><i class="required_fields">*</i>企业营业执照：</span>
											<input type="file" id="license up" name="license" class="up_file up_files" title="文件不大于5M" />
											<!--<span class="idcardupload" id="up">选择文件</span>-->
										</label>
									</li>
									<li class="cheitm">
										<label class="ifro_item">
											<span class="info_man"><i class="required_fields">*</i>企业执照注册号：</span>
											<input type="text" id="license_code" name="license_code" value="{$info.license_code}" class="check_inp" />
										</label>
									</li>
									<li class="cheitm">
										<label class="ifro_item">
											<span class="info_man"><i class="required_fields">*</i>机构地址：</span>
											<input type="text" name="address" id="address" value="{$info.address}" class="check_inp" />
										</label>
									</li>

									<li class="cheitm">
										<label class="ifro_item">
											<span class="info_man"><i class="required_fields">*</i>联系人手机号：</span>
											<input type="text" id="mobile" name="mobile" value="{$info.mobile}" class="check_inp" />
										</label>
									</li>
									<li class="cheitm">
										<label class="ifro_item">
											<span class="info_man"><i class="required_fields">*</i>法人手机号：</span>
											<input type="text" id="faren_mobile" name="faren_mobile" value="{$info.faren_mobile}" class="check_inp" />
										</label>
									</li>
									<li class="cheitm">
										<label class="ifro_item">
											<span class="info_man"><i class="required_fields">*</i>邮箱地址：</span>
											<input type="text" id="email" name="email" value="{$info.email}" class="check_inp" />
										</label>
									</li>
									<li class="cheitm">
										<label class="ifro_item">
											<span class="info_man"><i class="required_fields">*</i>组织机构简码：</span>
											<input type="text" id="jian_code" name="jian_code" value="{$info.jian_code}" class="check_inp" />
										</label>
									</li>
								</ul>
							</div>	
							<!--完成-->
							<!--<div class="add_finish equip_finish">-->
								<!--<a id="save1" class="opass equipfinish engin_finish">保存</a>-->
								<!--<a class="opass equipfinish engin_finish_exit">取消</a>-->
							<!--</div>-->

				</div><!--equip_infomation-->

			</div><!--equip_info-->
			<div class="equip_info ">
				<div class="equip_title engin_title">
					<i class="equip_i"></i>
					<span>企业资质</span>
					<a class="organ-add">
						<i class="engin_add"></i>
						<span class="engin_add_text" id="new_builds">新建企业资质</span>
					</a>
				</div>
				<div class="equip_infomation">
					<div class="detail-body check_bd clearfix">
						<div class="table">
							<table class="layui-table fac_table" lay-skin="line">
								<thead>
								<tr>
									<th>序号</th>
									<th>证书编号</th>
									<th>证书名称</th>
									<th>资质等级</th>
									<th>证书到期日期</th>
									<th>证书正面</th>
									<th>证书反面</th>
									<th>删除</th>
								</tr>
								</thead>
								<tbody class="fac_tbody" id="zizhi">

								<?php foreach($info['zizhi'] as $k=>$v){ ?>
								<tr class="zizhi_tr">
									<td>{$k+1}</td>
									<td>
										<input type="text" name="a_code[]" value="{$v.code}" class="fac_edittr_input fac_edittr_inputs a_code" placeholder="输入证书编号"  />
										<input type="hidden" class="fac_edittr_input fac_edittr_inputs" name="a_id[]" value="{$v.id}"  />
										</td>
									<td>
										<input type="text" value="{$v.name}" name="a_name[]" class="fac_edittr_input fac_edittr_inputs a_name" placeholder="输入证书名称"  />
										</td>
									<td>
										<select name="a_level[]" class="fac_edittr_input fac_edittr_inputs organ-info cenz check_inp check_inps a_level" >
											<option value="">选择资质等级</option>
											<option <?php if($v['level']==1): ?>selected="selected"<?php endif; ?> value="1">初级</option>
											<option <?php if($v['level']==2): ?>selected="selected"<?php endif; ?> value="2">中级</option>
											<option <?php if($v['level']==3): ?>selected="selected"<?php endif; ?> value="3">高级</option>
										</select>
									</td>
									<td>
										<input onclick="laydate()" name="a_daoqi[]" value="{$v.daoqi}" placeholder="输入到期日期" value="" class="fac_edittr_input fac_edittr_inputs check_inp check_inp_date picker-date a_daoqi"></td>
									<td>
										<input name="a_zheng{$k+1}" type="file" style="width:80px;" class="check_inp check_upload a_zheng" />
										<span class="idcarduploadrg">更改文件</span>
										</td>
									<td>
										<input name="a_fan{$k+1}" type="file" style="width:80px;" class="check_inp check_upload a_fan" />
										<span class="idcarduploadrg">更改文件</span>
										</td>
									<td data="{$v.id}" class="del_edittim"><i class="del_edits" id=""></i></td>
								</tr>
								<?php } ?>

								</tbody>
							</table>
						</div>
					</div>

				</div>
			</div>

			<!--关联信息-->
			<div class="equip_info">
				<div class="equip_title engin_title">
					<i class="equip_i"></i>
					<span>下级部门</span>
				</div>
				<div class="equip_infomation">
					<div class="detail-ftall clearfix" id="detail_alls">
						<?php foreach($info['section'] as $k=>$v){ ?>
						<div class="detail-ftitem detail_edit">
							<div class="detail-log">部门{$k+1}</div>
							<i class="del_check" data="{$v['id']}" id="detail_del"></i>
							<ul class="check-infol item_li">
								<li class="cheitm">
									<label class="ifro_item">
										<span class="info_man"><i class="required_fields">*</i>部门编号：</span>
										<input type="hidden" name="sec_id[]" value="{$v['id']}" >
										<input type="text" value="{$v['code']}" name="section_code[]" class="check_inp check_edit section_code" />
										</label>
									</li>
								<li class="cheitm">
									<label class="ifro_item">
										<span class="info_man"><i class="required_fields">*</i>部门名称：</span>
										<input type="text" value="{$v['name']}" name="section_name[]" class="check_inp check_edit section_name" />
										</label>
									</li>
								</ul>
							</div>
						<?php } ?>

						<div class="detail-ftitem detail_edit detailedit_add" >
							<div class="detatl_editadd">
								<i class="det_addet" id="new_section"></i>
								<p><a  id="add_detail"  class="edit_add">新建部门</a></p>
							</div>
						</div>
					</div>
					<!--完成-->
					<div class="add_finish equip_finish">
						<a id="save1" class="opass equipfinish engin_finish">保存</a>
						<a onclick="javascript:history.go(-1);" class="opass equipfinish engin_finish_exit">取消</a>
					</div>

				</div><!--equip_infomation-->
			</div><!--equip_info-->
			</form>
		</div><!--content-->	
<include file="Public:footer"/>
<script src="__PUBLIC__/assets/js/laydate/laydate.js"></script>
<script type="text/javascript">
	$(function() {
    /*多图上传*/
    jQuery.fn.extend({
        uploadPreview: function(opts) {
            var _self = this,
                _this = $(this);
            opts = jQuery.extend({
                Img: "ImgPr",
                Width: 100,
                Height: 100,
                ImgType: ["gif", "jpeg", "jpg", "bmp", "png"],
                Callback: function() {}
            }, opts || {});
            _self.getObjectURL = function(file) {
                var url = null;
                if (window.createObjectURL != undefined) {
                    url = window.createObjectURL(file)
                } else if (window.URL != undefined) {
                    url = window.URL.createObjectURL(file)
                } else if (window.webkitURL != undefined) {
                    url = window.webkitURL.createObjectURL(file)
                }
                return url
            };
            _this.change(function() {
                if (this.value) {
                    if (!RegExp("\.(" + opts.ImgType.join("|") + ")$", "i").test(this.value.toLowerCase())) {
                        alert("选择文件错误,图片类型必须是" + opts.ImgType.join("，") + "中的一种");
                        this.value = "";
                        return false
                    }
                    if ($.browser.msie) {
                        try {
                            $("#" + opts.Img).attr('src', _self.getObjectURL(this.files[0]))
                        } catch (e) {
                            var src = "";
                            var obj = $("#" + opts.Img);
                            var div = obj.parent("div")[0];
                            _self.select();
                            if (top != self) {
                                window.parent.document.body.focus()
                            } else {
                                _self.blur()
                            }
                            src = document.selection.createRange().text;
                            document.selection.empty();
                            obj.hide();
                            obj.parent("div").css({
                                'filter': 'progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod=scale)',
                                'width': opts.Width + 'px',
                                'height': opts.Height + 'px'
                            });
                            div.filters.item("DXImageTransform.Microsoft.AlphaImageLoader").src = src
                        }
                    } else {
                        $("#" + opts.Img).attr('src', _self.getObjectURL(this.files[0]))
                    }
                    opts.Callback()
                }
            })
        }
    });



    $("#up").uploadPreview({
        Img: "ImgPr",
        Width: 120,
        Height: 120
    });

})
</script>
<script>

	$(document).on('click','#save1',function(){
		var name = $('#name').val();
		var license = $('#license').val();
		var jiancheng = $('#jiancheng').val();
		var license_code = $('#license_code').val();
		var sheng = $('#sheng').val();
		var shi = $('#shi').val();
		var contact = $('#contact').val();
		var address = $('#address').val();
		var mobile = $('#mobile').val();
		var faren = $('#faren').val();
		var faren_mobile = $('#faren_mobile').val();

		var type = $('#type').val();
		var email = $('#email').val();
		var company_code = $('#conpany_code').val();
		var jian_code = $('#jian_code').val();

		if(name == '' ){
			layer.msg('组织机构名称不能为空', {time: 1500});
			return false;
		}

		<?php if(ACTION_NAME=='organ_add'): ?>
		if(license == '' ){
			layer.msg('企业营业执照不能为空', {time: 1500});
			return false;
		}
		<?php endif; ?>

		if(jiancheng == '' ){
			layer.msg('组织机构简称不能为空', {time: 1500});
			return false;
		}

		if(license_code == '' ){
			layer.msg('企业执照注册号不能为空', {time: 1500});
			return false;
		}

		if(sheng == '' ){
			layer.msg('省份不能为空', {time: 1500});
			return false;
		}

		if(shi == '' ){
			layer.msg('城市不能为空', {time: 1500});
			return false;
		}

		if(contact == '' ){
			layer.msg('联系人不能为空', {time: 1500});
			return false;
		}

		if(address == '' ){
			layer.msg('机构地址不能为空', {time: 1500});
			return false;
		}

		if(mobile == '' ){
			layer.msg('手机号不能为空', {time: 1500});
			return false;
		}

		var pattern = /^1[34578]\d{9}$/;

		if(pattern.test(mobile)==false){
			layer.msg('联系人手机号码格式不正确', {time: 1500});
			return false;
		}

		if(faren == '' ){
			layer.msg('法人不能为空', {time: 1500});
			return false;
		}

		if(faren_mobile == '' ){
			layer.msg('法人手机号不能为空', {time: 1500});
			return false;
		}


		if(pattern.test(faren_mobile)==false){
			layer.msg('法人手机号格式不正确', {time: 1500});
			return false;
		}

		if(type == '' ){
			layer.msg('组织机构类别不能为空', {time: 1500});
			return false;
		}

		if(email == '' ){
			layer.msg('邮箱不能为空', {time: 1500});
			return false;
		}

		var res = /^([a-zA-Z0-9_-])+@([a-zA-Z0-9_-])+(.[a-zA-Z0-9_-])+/;
		if(res.test(email) == false){
			layer.msg('邮箱格式不正确', {time: 2000});
			return false;
		}

		if(company_code == '' ){
			layer.msg('组织机构代码不能为空', {time: 1500});
			return false;
		}

		if(jian_code == '' ){
			layer.msg('组织机构简码不能为空', {time: 1500});
			return false;
		}

		var is_null = 0;
		$('.section_code').each(function(){

			if($(this).val()==''){
				is_null++;
			}
		})

		if(is_null>0){
			layer.msg('部门编号不能为空', {time: 1500});
			return false;
		}

		var is_null = 0;
		$('.section_name').each(function(){

			if($(this).val()==''){
				is_null++;
			}
		})

		if(is_null>0){
			layer.msg('部门名称不能为空', {time: 1500});
			return false;
		}




		var is_null = 0;
		$('.a_code').each(function(){

			if($(this).val()==''){
				is_null++;
			}
		})

		if(is_null>0){
			layer.msg('证书编号不能为空', {time: 1500});
			return false;
		}

		var is_null = 0;
		$('.a_name').each(function(){

			if($(this).val()==''){
				is_null++;
			}
		})

		if(is_null>0){
			layer.msg('证书名称不能为空', {time: 1500});
			return false;
		}

		var is_null = 0;
		$('.a_level').each(function(){

			if($(this).val()==''){
				is_null++;
			}
		})

		if(is_null>0){
			layer.msg('资质等级不能为空', {time: 1500});
			return false;
		}

		var is_null = 0;
		$('.a_daoqi').each(function(){

			if($(this).val()==''){
				is_null++;
			}
		})

		if(is_null>0){
			layer.msg('证书到期日期不能为空', {time: 1500});
			return false;
		}

		<?php if(ACTION_NAME=='organ_add'): ?>
		var is_null = 0;
		$('.a_zheng').each(function(){

			if($(this).val()==''){
				is_null++;
			}
		})

		if(is_null>0){
			layer.msg('证书正面不能为空', {time: 1500});
			return false;
		}

		var is_null = 0;
		$('.a_fan').each(function(){

			if($(this).val()==''){
				is_null++;
			}
		})

		if(is_null>0){
			layer.msg('证书反面不能为空', {time: 1500});
			return false;
		}
		<?php endif; ?>

		$('#form1').submit();

	})

	$(function(){
		$(document).on('click','#detail_del',function(){
			if($(this).attr('data')==''){
				$(this).parent('.detail-ftitem').remove();
			}else{
				var id = $(this).attr('data');
				layer.load(1, {
					shade: [0.1,'#fff'] //0.1透明度的白色背景
				});
				$.ajax({
					url:"{:U('Admin/Organization/organ_edit')}",
					dataType:'json',
					type:'post',
					data:{
						'do':'del_sec',
						'id':id

					},
					success:function(e){
						layer.closeAll();
						layer.msg(e.msg, {time: 1500});
						if(e.status ==1){
							$(this).parent('.detail-ftitem').remove();
						}

					}
				})
			}

			return false;


		})

		$(document).on('click','#new_builds',function(){

			var num = 1;
			$('.zizhi_tr').each(function(){
				num ++;
			})


			var html = $('#zizhi').html();
			html+=  '<tr class="zizhi_tr">'+
						'<td>'+num+'</td>'+
						'<td>'+
							'<input type="text" name="a_code[]" class="fac_edittr_input fac_edittr_inputs a_code" placeholder="输入证书编号"  />'+
							'<input type="hidden" class="fac_edittr_input fac_edittr_inputs" name="a_id[]" value=""  />'+
						'</td>'+
						'<td>'+
							'<input type="text" name="a_name[]" class="fac_edittr_input fac_edittr_inputs a_name" placeholder="输入证书名称"  />'+
						'</td>'+
						'<td>'+
							'<select name="a_level[]" class="fac_edittr_input fac_edittr_inputs organ-info cenz check_inp check_inps a_level" >'+
								'<option value="">选择资质等级</option>'+
								'<option value="1">初级</option>'+
								'<option value="2">中级</option>'+
								'<option value="3">高级</option>'+
							'</select>'+
						'</td>'+
						'<td>'+
							'<input onclick="laydate()" name="a_daoqi[]"  placeholder="输入到期日期" value="" class="fac_edittr_input fac_edittr_inputs check_inp check_inp_date picker-date a_daoqi"></td>'+
						'<td>'+
							'<input name="a_zheng'+num+'" type="file" style="width:80px;" class="check_inp check_upload a_zheng" />'+
							'<span class="idcarduploadrg">选择文件</span>'+
						'</td>'+
						'<td>'+
							'<input name="a_fan'+num+'" type="file" style="width:80px;" class="check_inp check_upload a_fan" />'+
							'<span class="idcarduploadrg">选择文件</span>'+
						'</td>'+
						'<td data="0" class="del_edittim"><i class="del_edits" id=""></i></td>'+
					'</tr>';

			$('#zizhi').html(html);
			return false;
		})

		$(document).on('click','.del_edittim',function(){
			var id=$(this).attr('data');
			if(id==0){
				$(this).parent().remove();
				return false;
			}else{
				layer.load(1, {
					shade: [0.1,'#fff'] //0.1透明度的白色背景
				});

				$.ajax({
					url:"{:U('Admin/Organization')}"+'/'+"{:ACTION_NAME}",
					dataType:'json',
					type:'post',
					data:{
						do:'del_apt',
						id:id
					},
					success:function(e){
						layer.closeAll();
						layer.msg(e.msg, {time: 2000});
						if(e.status!=1){
							return false;
						}

					}
				})
			}
			$(this).parent().remove();
		})

		$(document).on('click','#new_section',function(){

			var num = 1;
			$('.item_li').each(function(){
				num ++;
			})


//循环部门
			var html = '<div class="detail-ftitem detail_edit">'+
							'<div class="detail-log">部门'+num+'</div>'+
							'<i class="del_check" data="" id="detail_del"></i>'+
							'<ul class="check-infol item_li">'+
								'<li class="cheitm">'+
									'<label class="ifro_item">'+
										'<span class="info_man"><i class="required_fields">*</i>部门编号：</span>'+
										'<input type="hidden" name="sec_id[]" value="" >'+
										'<input type="text" name="section_code[]" class="check_inp check_edit section_code" />'+
									'</label>'+
								'</li>'+
								'<li class="cheitm">'+
									'<label class="ifro_item">'+
										'<span class="info_man"><i class="required_fields">*</i>部门名称：</span>'+
										'<input type="text" name="section_name[]" class="check_inp check_edit section_name" />'+
									'</label>'+
								'</li>'+
							'</ul>'+
						'</div>';

			$('.detailedit_add').before(html);

		})


	});

	$('#sheng').change(function(){
		var sheng = $('#sheng').val();
		if(sheng==''){
			$('#shi').html("<option value=''>请先选择省份</option>");
			return false;
		}if(sheng=='47494' || sheng=='47495'){
			$('#shi').html("<option value=''>---</option>");
			return false;
		}else{
			layer.load(1, {
				shade: [0.1,'#fff'] //0.1透明度的白色背景
			});
			$.ajax({
				url:"{:U('Admin/Organization/organ_edit')}",
				dataType:'json',
				type:'post',
				data:{
					'sheng':sheng,
					'id':1,
					'do':'get_shi'
				},
				success:function(e){
					if(e.status !=1){
						layer.closeAll();
						layer.msg(e.msg, {time: 1500});
						return false;
					}

					var html = "<option value=''>请选择城市</option>";

					for(i=0;i<e.data.length;i++){
						html+='<option value="'+ e.data[i].id+'">'+e.data[i].name+'</option>';
					}

					$('#shi').html(html);
					layer.closeAll();
				}
			})
		}

	})
</script>