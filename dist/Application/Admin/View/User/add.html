<include file="Public:header"/>
<!-- begin #content -->
<div id="content" class="content">
  <!-- begin page-header -->
  <h1 class="page-header">{$title}</h1>
  <!-- end page-header -->   
  <!-- begin row -->
  <div class="row">
    <!-- begin col-6 -->
    <div class="col-md-12 admin-grid index-chart">
      <!-- begin panel -->
      <div class="panel panel-inverse" data-sortable-id="form-stuff-1">
        <div class="panel-body">
          <form class="form-horizontal" method='post' action='{:U("User/".ACTION_NAME)}'>
            <input type='hidden' name='do' value='save'/>
            <if condition="ACTION_NAME eq 'edit'"> 
              <input type='hidden' name='uid' value='{$info.uid}'/>
            </if>
            <?php if(ACTION_NAME == 'add' && session()['userinfo']['groupid']!=1): ?>
              <input type="hidden" id="roleSelect1" value="1">
            <?php elseif(ACTION_NAME == 'add' && session()['userinfo']['groupid']==1): ?>
              <input type="hidden" id="roleSelect1" value="0">

            <?php else: ?>
              <input type="hidden" id="roleSelect1" value="1">

            <?php endif; ?>

            <div class="form-group">
              <label class="col-md-3 control-label">登录账号</label>
              <div class="col-lg-5">
                <input type="text" class="form-control" placeholder="登录账号" autocomplete='off' value="{$info.username}" name="username" {:ACTION_NAME=='edit'?'readonly="true"':''} />
              </div>
            </div>
            <div class="form-group">
              <label class="col-md-3 control-label">登录密码</label>
              <div class="col-lg-5">
                <input type="password" class="form-control" name='password' autocomplete='off' placeholder="登录密码" {:ACTION_NAME=='edit'?'readonly="true"':''} />
              </div>
            </div>
            <div class="form-group">
              <label class="col-md-3 control-label">确认密码</label>
              <div class="col-lg-5">
                <input type="password" class="form-control" name='repassword' autocomplete='off' placeholder="确认密码" {:ACTION_NAME=='edit'?'readonly="true"':''} />
              </div>
            </div>

            <div class="form-group">
              <label class="col-md-3 control-label">姓名</label>
              <div class="col-lg-5">
                <input type="text" class="form-control" placeholder="姓名" autocomplete='off' value="{$info.nicename}" name="nicename"  />
              </div>
            </div>
            <div class="form-group">
              <label class="col-md-3 control-label">邮箱</label>
              <div class="col-lg-5">
                <input type="text" class="form-control" name='email' value='{$info.email}' placeholder="邮箱"  />
              </div>
            </div>
            <div class="form-group">
              <label class="col-md-3 control-label">手机号码</label>
              <div class="col-lg-5">
                <input type="text" class="form-control" name='mobile' value='{$info.mobile}' placeholder="手机号码" />
              </div>
            </div>
            <?php if(session()['userinfo']['groupid']==1): ?>

            <div class="form-group">
              <label class="col-md-3 control-label">选择公司</label>
              <div class="col-lg-5">
                <button class="btn btn-info btn-sm" type="button" id="chose_company">选择</button>
                <input type="hidden" name="company_id" id="company_id" value="{$info.company_id}">
              </div>
            </div>

            <div class="form-group">
              <label class="col-md-3 control-label">所属公司</label>
              <div class="col-lg-5">
                <label style="text-align: left;width:100%;" class="col-md-3 control-label" id="company_name">{$info_company_name}</label>
              </div>
            </div>
            <?php endif; ?>



            <?php if(session()['userinfo']['groupid']==1): ?>
            <div class="form-group">
              <label class="col-md-3 control-label">角色</label>
              <div class="col-lg-5">

                  <select name='groups' id='roleSelect' class="form-control">

                  <?php if(ACTION_NAME == 'add'): ?>
                      <option value=''>选择角色</option>
                      <option value=''>请先选择公司</option>
                  <?php else: ?>
                      <option value=''>选择角色</option>
                      <volist name='groups' id='vo'>
                        <option value='{$vo.id}' {:in_array($vo['id'],$result)?'selected':''}>{$vo.title}</option>
                      </volist>
                  <?php endif; ?>

                </select>
              </div>
            </div>


            <?php else: ?>
            <div class="form-group">
              <label class="col-md-3 control-label">角色</label>
              <div class="col-lg-5">
                  <select name='groups' id='roleSelect' class="form-control">

                  <option value=''>选择角色</option>
                  <volist name='groups' id='vo'>
                    <option value='{$vo.id}' {:in_array($vo['id'],$result)?'selected="selected"':''}>{$vo.title}</option>
                  </volist>

                </select>
              </div>
            </div>
            <?php endif; ?>
            <div class="form-group">
              <label class="col-md-3 control-label">人员资质</label>
              <div class="col-lg-5">
                <input type="text" class="form-control" placeholder="人员资质" autocomplete='off' value="{$info.zizhi}" name="zizhi"  />
              </div>
            </div>
            <div class="form-group">
              <label class="col-md-3 control-label">身份证</label>
              <div class="col-lg-5">
                <input type="text" class="form-control" placeholder="身份证" autocomplete='off' value="{$info.IDcard}" name="IDcard"  />
              </div>
            </div>
            <div class="form-group">
              <label class="col-md-3 control-label">身份证正面</label>
              <div class="col-lg-5">
                <button class="btn btn-info btn-sm" type="button" id="chose_img">选择图片</button>
              </div>
              <div class="col-lg-2">
                <input name="index_img" id="index_img" type="hidden" class="msgs" value="{$index_img['picturepath']}"  />
                <input name="picpath" id="picpath" type="hidden" class="msgs" value="{$index_img['picturepath']}"  />
              </div>
            </div>
            <div class="form-group">
              <label class="col-md-3 control-label"></label>
              <div class="col-lg-5">
                <img src="{:empty($info['IDcard_zheng'])?'/Public/IDcard/index_img/default.png':$info['IDcard_zheng']}" id="show_img" height="100" />
              </div>
            </div>

            <div class="form-group">
              <label class="col-md-3 control-label">身份证反面</label>
              <div class="col-lg-5">
                <button class="btn btn-info btn-sm" type="button" id="chose_img1">选择图片</button>
              </div>
              <div class="col-lg-2">
                <input name="index_img1" id="index_img1" type="hidden" class="msgs" value="{$index_img['picturepath']}"  />
                <input name="picpath1" id="picpath1" type="hidden" class="msgs" value="{$index_img['picturepath']}"  />
              </div>
            </div>
            <div class="form-group">
              <label class="col-md-3 control-label"></label>
              <div class="col-lg-5">
                <img src="{:empty($info['IDcard_fan'])?'/Public/IDcard/index_img/default.png':$info['IDcard_fan']}" id="show_img1" height="100" />
              </div>
            </div>
            <div class="form-group">
              <label class="col-md-3 control-label">人员编号</label>
              <div class="col-lg-5">
                <input type="text" class="form-control" placeholder="人员编号" autocomplete='off' value="{$info.person_code}" name="person_code"  />
              </div>
            </div>
            <div class="form-group">
              <label class="col-md-3 control-label">联系地址</label>
              <div class="col-lg-5">
                <input type="text" class="form-control" placeholder="联系地址" autocomplete='off' value="{$info.address}" name="address"  />
              </div>
            </div>


<!--             <div class="form-group">
              <label class="col-md-3 control-label">QQ</label>
              <div class="col-lg-5">
                <input type="text" class="form-control" name='qq' value='{$info.qq}' placeholder="QQ" />
              </div>
            </div> -->
            <div class="form-group">
              <div class="col-sm-offset-3 col-sm-2">
                  <a href='{:U('User/index')}' class='btn btn-sm btn-default m-r-5 btn-block'>返 回</a>
              </div>
              <div class="col-sm-2">
                
                <button type="submit" class="btn btn-sm btn-danger btn-block">提 交</button>
              </div>
            </div>
          </form>
        </div>
      </div>
      <!-- end panel -->
    </div>
    <!-- end col-6 -->
  </div>
  <!-- end row -->
</div>
<!-- end #content -->

<script type='text/javascript'>
  var Page = {
    init:function(){
      this.bind();
      this.ajaxUpload('#chose_img', 'index_img');
      this.ajaxUpload1('#chose_img1', 'index_img1');
      //this.ajaxUpload('#file_upload','show_file');
//            SJ.qiniu('{$qiniuToken}');
    },
    bind:function(){

      $('#chose_company').click(function(){
        var that = $(this);
        console.log('123');

        $.ajax({
          url:"{:U('/Admin/User/company')}",
//          dataType:'json',
          type:'post',
          success:function(e){

            console.log(e);

            layer.open({
              title: '公司列表',
              type: 1,
              skin: 'layui-layer-demo', //加上边框
              anim: 5,
              area: ['750px', '600px'], //宽高
              content: e
            });
          }
        })

//        console.log(456);
//        return false;
      })

      $(document).on('click','#roleSelect',function(){
          var id = $('#company_id').val();
          var change = $('#roleSelect1').val();
          if(id=='' || change=='1'){
            return false;
          }

        layer.load(1, {
          shade: [0.1,'#fff'] //0.1透明度的白色背景
        });

        $.ajax({
          url:"{:U('Admin/User/add')}",
          dataType:'json',
          type:'post',
          data:{
            'company_id':id,
            'do':'get_group'
          },
          success:function(e){
            layer.closeAll();
            if(e.status!=1){
              layer.msg(e.msg, {time: 1500});
              return false;
            }

            var selected = '{info["company_id"]}';
            var html = '<option value="">选择角色</option>';
            console.log(e.data);
            for(i=0;i<e.data.length;i++){
//              console.log(e.data[i].id);
              if(e.data[i].id == selected){
                html+="<option selected='selected' value='"+e.data[i].id+"'>选择角色</option>";
              }else{
                html+="<option value='"+e.data[i].id+"'>"+ e.data[i].title+"</option>";
              }
            }
            console.log(html);
            $('#roleSelect').html(html);
            $('#roleSelect1').val('1');

          }
        })
      })

      $(function(){
        $('form').validator({
          theme:'yellow_top',
          msgClass:'n-right',
          msgIcon:'',
          msgMaker: function(opt){
            if(!opt.msg){
              return '';
            }
            return '<span class="msg-wrap n-error" role="alert"><span class="n-msg">'+opt.msg+'</span></span>'
          },
          messages: {
            match:{
              eq:"两次输入密码不一致！"
            }
          },
          fields: {
            'groups':'角色:required;',
            'username': "用户名称:required;username;remote[get:<php>echo U('User/add',array('do'=>'check'));</php>, username, uid]",
            'email': "邮箱:required;email;remote[get:<php> echo U('User/add',array('do'=>'check'));</php>, email, uid]",
            'nicename': "姓名:required;",
            'company': "所属公司:required;",
            'zizhi': "人员资质:required;",
            'IDcard': "身份证:required;",

            'person_code': "人员资质:required;",
            'address': "联系地址:required;",
            'mobile': "手机号码:required;mobile;remote[get:<php> echo U('User/add',array('do'=>'check'));</php>, mobile, uid]",
        <if condition="ACTION_NAME eq 'add'">
          'picpath': "身份证正面:required;",
          'picpath1': "身份证反面:required;",
          'password': "登录密码:required;",
          'repassword':"确认密码:required;match(password)"
          <else />
          'repassword':"match(password);"
        </if>

      }
      });
      })

      $('input[name="picpath"]').val("");
      $('input[name="picpath1"]').val("");



    },
    openLayer: function(title,url,width,height){
      if(width == ''){
        width = '1200px';
      }
      if(height == ''){
        height = '650px';
      }
      layer.open({
        type: 2,
        title: title,
        area: [width, height], //宽高
        closeBtn: 1, //不显示关闭按钮
        shift: 2,
        shadeClose: true, //开启遮罩关闭
        content: url
      });
    },

    ajaxUpload: function(element,input_file_name){
      var _this = this;
      new AjaxUpload($(element),{
        action: "{:U('User/add')}",
        name: input_file_name,
        responseType:'json',
        onSubmit : function(file, ext){
          if (ext && /^(jpg|png|jpeg|gif|JPG)$/.test(ext)){
            if(input_file_name == 'index_img'){
              this.setData({
                'do': 'upload',
                'oldimg':$('#show_img').attr('src'),
                'file_name':input_file_name
              });
            } else {
              this.setData({
                'do': 'upload',
                'oldimg':$('#show_img').attr('src'),
                'file_name':input_file_name
              });
            }

          } else {
            layer.msg('文件格式错误，请上传格式为.png .jpg .jpeg 的图片');
            return false;
          }
          this.disable();
          layer.load(1, {
            shade: [0.1,'#fff'] //0.1透明度的白色背景
          });
        },
        onComplete: function(file, response){
          layer.closeAll();
          if(response.status==0){
            layer.msg(response.msg);
          } else {
            if(input_file_name == 'show_file'){
              var html = $("#show_img").html();
              html += '<div class="row col-md-3"><div class="col-md-12" style="text-align:center;">' +
                      '<img src="'+response.img+'" width="150px" height="150" class="showImg"/>' +
                      '</div><div class="col-md-12" style="margin-top:10px;margin-bottom:20px;text-align:center;">' +
                      '<a href="javascript:void(0)" class="btn btn-danger btn-sm img_del">删除</a>' +
                      '<input type="hidden" name="img[]" value="'+response.img+'" /></div></div>';
              $("#show_img").html(html);
            } else {
              $('#show_img').attr('src',response.img);
              $('input[name="picpath"]').val(response.img);
            }
          }
          this.enable();
        }
      });
    },


    ajaxUpload1: function(element,input_file_name){
      var _this = this;
      new AjaxUpload($(element),{
        action: "{:U('User/add')}",
        name: input_file_name,
        responseType:'json',
        onSubmit : function(file, ext){
          if (ext && /^(jpg|png|jpeg|gif|JPG)$/.test(ext)){
            if(input_file_name == 'index_img1'){
              this.setData({
                'do': 'upload',
                'oldimg':$('#show_img1').attr('src'),
                'file_name':input_file_name
              });
            } else {
              this.setData({
                'do': 'upload',
                'oldimg':$('#show_img1').attr('src'),
                'file_name':input_file_name
              });
            }

          } else {
            layer.msg('文件格式错误，请上传格式为.png .jpg .jpeg 的图片');
            return false;
          }
          this.disable();
          layer.load(1, {
            shade: [0.1,'#fff'] //0.1透明度的白色背景
          });
        },
        onComplete: function(file, response){
          layer.closeAll();
          if(response.status==0){
            layer.msg(response.msg);
          } else {
            if(input_file_name == 'show_file'){
              var html = $("#show_img").html();
              html += '<div class="row col-md-3"><div class="col-md-12" style="text-align:center;">' +
                      '<img src="'+response.img+'" width="150px" height="150" class="showImg"/>' +
                      '</div><div class="col-md-12" style="margin-top:10px;margin-bottom:20px;text-align:center;">' +
                      '<a href="javascript:void(0)" class="btn btn-danger btn-sm img_del">删除</a>' +
                      '<input type="hidden" name="img[]" value="'+response.img+'" /></div></div>';
              $("#show_img").html(html);
            } else {
              $('#show_img1').attr('src',response.img);
              $('input[name="picpath1"]').val(response.img);
            }
          }
          this.enable();
        }
      });
    }
  };
  $(function(){
    Page.init();
  })
</script>
<include file="Public:footer"/>