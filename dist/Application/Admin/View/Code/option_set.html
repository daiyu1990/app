<include file="Public:header"/>
		<!-- begin #content -->
		<div id="content" class="content">
			<!-- begin page-header -->
			<h1 class="page-header">{$info.name}</h1>
			<!-- end page-header -->
            <!-- begin row -->
            <div class="row">
                <!-- begin col-12 -->
                <div class="col-12">
                    <!-- begin panel -->
                    <div class="panel panel-inverse" data-sortable-id="form-stuff-5">
                        <div class="panel-heading">
                            <h4 class="panel-title">选项组管理</h4>
                        </div>
                        <div class="panel-body">
							<div class="form-group m-r-10">
								<div class='col-lg-2'>
									<select id='options' class='form-control'>
										<volist name='options' id='vo'>
										<option value='{$vo.id}' {$info['id'] == $vo['id']?'selected':''}>{$vo.name}|{$vo.code}</option>
										</volist>
									</select>
								</div>
								<div class='col-lg-5'>
									<a href="{:U('Code/add',array('id'=>I('cid')))}" id='editcode' class="btn btn-sm btn-info m-r-5">修改</a>
									<a href="{:U('Code/del',array('id'=>I('cid')))}" ctype='1' class="btn btn-sm btn-danger m-r-5 del">删除</a>
									<a href='{:U('Code/add')}' id='addcode' class="btn btn-sm btn-primary">添加</a>
								</div>
							</div>
                        </div>
                    </div>
                    <!-- end panel -->
                    <!-- begin panel -->
                    <div class="panel panel-inverse" data-sortable-id="form-stuff-5">
                        <div class="panel-heading">
                            <h4 class="panel-title">{$info.name} > 子项添加</h4>
                        </div>
                        <div class="panel-body">
	                        <form method='post' id='addChildren' action='{:U('Code/add')}'>
	                        	<input type='hidden' name='do' value='saveChild'/>
	                        	<input type='hidden' name='code' value='{$info.code}'/>
								<div class="form-group m-r-10">
									<div class='col-lg-2'>
										<select name='pid' id='pids' class='form-control'>
											<option value='0'>{$info.name}</option>
											<php>echo \Admin\Model\CodeModel::treeSel($codess, I('pid',0), null, '─')</php>
										</select>
									</div>
									<div class='col-lg-2'>
										<input type="text" class="form-control" name='name' placeholder="子选项名称" />
									</div>
									<div class='col-lg-2'>
										<input type="text" class="form-control" name='val' placeholder="子选项值" />
									</div>
									<div class='col-lg-2'>
										<input type="number" class="form-control" name='ord' min='1' value='1' placeholder="子选项排序" />
									</div>
									<div class='col-lg-3'>
										<button type="submit" class="btn btn-sm btn-primary">添加</button>
									</div>
								</div>
							</form>
	                    </div>

                    </div>
                    <!-- end panel -->
                    <!-- begin panel -->
                    <div class="panel panel-inverse" data-sortable-id="form-stuff-5">
                        <div class="panel-heading">
                            <h4 class="panel-title">{$info.name} > 子项管理</h4>
                        </div>
                        <div class="panel-body">
							<table id='data-table' class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>选项名称</th>
                                        <th>选项值</th>
                                        <th>排序</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                	
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <!-- end panel -->
                </div>
                <!-- end col-6 -->
            </div>
            <!-- end row -->

		</div>
		<!-- end #content -->
	<script type='text/javascript'>
		var Page = {
			init:function(){
				this.bind();
				this.renderTable();
			},
			refreshCur:function(){
				$.ajax({
					url:'{:U('Code/add',array('do'=>'getSelfandChild','cid'=>I('cid')))}',
					data:{pid:$('#pids').val()},
					success:function(res){
						var option_default = '<option value="0">{$info.name}</option>';
						$('#pids').html(option_default+res);
					}
				})
			},
			bind:function(){
				var _this = this;
				$('#pids').change(function(){
					_this.pid = $(this).val();
					_this.renderTable();
				})
				$('#addChildren').validator({
		            theme:'yellow_top',
		            msgClass:'n-top',
		            msgIcon:'',
		            msgMaker: function(opt){
		              if(!opt.msg){
		                return '';
		              }
		              return '<span class="msg-wrap n-error" role="alert"><span class="n-msg">'+opt.msg+'</span></span>'
		            },
		            fields: {
		                'name': "选项名称:required;",
		                'val': "选项值:required;"
		            },
		            valid: function(form){
		                var loading=layer.load(1, {
		                    shade: [0.1, '#fff'] //0.1透明度的白色背景
		                });;
		                var options = {
		                    success: function (data) {
		                        layer.close(loading);
		                        _this.renderTable();
		                        $('input[name="name"]').val('');
		                        $('input[name="val"]').val('');
		                        $('input[name="ord"]').val('1');
		                        _this.refreshCur();
		                    }
		                };
		                $(form).ajaxSubmit(options);
		                return false;
		            }
		        });
		        $(document).on('click','#addcode,#editcode',function(){
	            	var that = $(this);
	            	$.ajax({
	            		url : that.attr('href'),
	            		success:function(result){
	            			_this.openLayer(that.text(),result,'600px','400px');
	            		}
	            	})
	            	return false;
	            })
	            $(document).on('click','.del',function(){
	            	var that = $(this);
	                var href = that.attr('href');
	                var text = that.text();
	                layer.confirm('确定'+text+'？', {
	                    btn: ['确定','取消'] //按钮
	                }, function(){
	                    $.ajax({
	                        url : href,
	                        dataType:'json',
	                        success: function(e){
	                            // _this.renderTable();
	                            if(e.status==0)
	                            {
	                              layer.alert(e.msg);
	                              return false;
	                            }
	                            _this.renderTable();
	                            if(that.attr('ctype') == 1){
	                            	$('#options option[value='+that.val()+']').remove();
	                            }
	                        }
	                    })
	                }, function(){
	                    // 取消
	                });
	                return false;
	            })
	            $(document).on('click','.edit',function(){
	            	var that = $(this);
	            	var name = $(this).parent().parent().find('input:eq(0)').val();
		            var ord = $(this).parent().parent().find('input:eq(2)').val();
		            var val = $(this).parent().parent().find('input:eq(1)').val();
	            	$.ajax({
	            		url:that.attr('href'),
	            		data:{name:name,ord:ord,val:val},
	            		dataType:'json',
	            		success:function(e){
	            			if(e.status==0)
                            {
                              layer.alert(e.msg);
                              return false;
                            }
                            _this.renderTable();
                            _this.refreshCur();
	            		}
	            	})
	            	return false;
	            })
			},
			openLayer: function(title,html,width='1200px',height='650px'){
	            layer.open({
	                type: 1,
	                title: title,
	                area: [width, height], //宽高
	                closeBtn: 1, //不显示关闭按钮
	                shift: 2,
	                shadeClose: true, //开启遮罩关闭
	                content: html
	            });
	        },
			code:'{$info.code}',
			pid:0,
			renderTable:function(){
				layer.load(1, {
	              shade: [0.1,'#fff'] //0.1透明度的白色背景
	            });
	            var _this = this;
	            $.ajax({
	            	url:'{:U('Code/add',array('do'=>'listTableData'))}',
	            	data:{pid:_this.pid,code:_this.code},
	            	success:function(res){
	            		layer.closeAll();
	            		$('#data-table tbody').remove();
	            		$('#data-table').append(res);
	            	}
	            })

			}
		}
		$(function(){
			Page.init();
		})
	</script>
<include file="Public:footer"/>