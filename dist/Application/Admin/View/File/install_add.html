<include file="Public:header"/>

<!-- begin #content -->
		<div id="content" class="content content_waring">	
			 <!-- begin page-header -->
		    <h1 class="page-header page_warging">
		    	<!--{$title}-->
		    	<a>档案管理 </a>》<a>安拆告知</a>》<a>{$title}</a>
		    	<a onclick="javascript:history.go(-1);" class="organ_back">
			    		<i class="engin_back"></i>
    					<span class="engin_add_text">返回</span>
			    </a>
		    </h1>
		    <!-- end page-header -->
			<!--总标题-->
			<div class="equip_head engin_head">
				<!--{$title}-->
				新增安拆告知
			</div>
			<form name="form1" id="form1" method="post" enctype="multipart/form-data" action='{:U("Admin/File/".ACTION_NAME)}' >
			<input name="do" value="save" type="hidden">
				<?php if(ACTION_NAME=='install_edit'): ?>
				<input type="hidden" name="id" value="{$info.id}" >
				<?php endif; ?>
			<!--设备信息-->
			<div class="equip_info ">
				<div class="equip_title engin_title">
					<i class="equip_i"></i>
					<span>设备信息</span>
				</div>
				<div class="equip_infomation">
					<!--设备信息编辑-->
						<div class="detail-body engin_edit_box clearfix">
							<div class="equip_list engin_boxt clearfix row">
								<div class="col-md-6">
									<div class="cheitm">
										<label class="ifro_item">
											<span class="info_man engin_span">产权备案编号：</span>
											<select id="r_id" name="r_id" class="check_inp chosen-select" >
												<option value="">请选择产权备案编号</option>
												<option value="{$info.r_id}">{$info.beian_code}</option>
												<?php foreach($beian as $k=>$v){ ?>
												<option value="{$v.id}">{$v.beian_code}</option>
												<?php } ?>

											</select>
										</label>
									</div>
								</div>
								<div class="col-md-6">
									<div class="cheitm">
										<label class="ifro_item">
											<span class="info_man engin_span">产权单位名称：</span>
											<span id="chanquan_company" class="check_inp check_inp_span">{$info.chanquan}</span>
										</label>
									</div>
								</div>
							</div>
							<input id="f_id" type="hidden" value="{$info.f_id}" name="f_id" >
							<div class="equip_list engin_boxt clearfix row">
								<div class="col-md-6">
									<div class="cheitm">
										<label class="ifro_item">
											<span class="info_man engin_span">设备编号：</span>
											<span id="fac_code" class="check_inp check_inp_span">{$info.facility_number}</span>
										</label>
									</div>
								</div>
								<div class="col-md-6">
									<div class="cheitm">
										<label class="ifro_item">
											<span class="info_man engin_span">设备类型：</span>
											<span id="fac_type" class="check_inp check_inp_span">{$info.facility_type}</span>
										</label>
									</div>
								</div>
							</div>
							<div class="equip_list engin_boxt clearfix row">
								<div class="col-md-6">
									<div class="cheitm">
										<label class="ifro_item">
											<span class="info_man engin_span">设备型号：</span>
											<span id="fac_xinghao" class="check_inp check_inp_span">{$info.facility_model_number}</span>
										</label>
									</div>
								</div>
								<div class="col-md-6">
									<div class="cheitm">
										<label class="ifro_item">
											<span class="info_man engin_span">出厂日期：</span>
											<span id="fac_chuchang" class="check_inp check_inp_span">{$info.factory_date}</span>
										</label>
									</div>
								</div>
							</div>
						</div>
						</div>
				</div><!--equip_infomation-->
			<!--告知信息-->
			<div class="equip_info equip_infot">
				<div class="equip_title engin_title">
					<i class="equip_i"></i>
					<span>告知信息</span>
				</div>
				<div class="equip_infomation">
					<!--设备信息编辑-->
						<div class="detail-body engin_edit_box clearfix">
							<div class="equip_list engin_boxt clearfix row">
								<div class="col-md-6">
									<div class="cheitm">
										<label class="ifro_item">
											<span class="info_man engin_span">安拆告知编号：</span>
											<input type="text" id="code" name="code" value="{$info.code}" class="check_inp" placeholder=" 输入安拆告知编号" />
										</label>
									</div>
								</div>
								<div class="col-md-6">
									<div class="cheitm">
										<label class="ifro_item">
											<span class="info_man engin_span">安拆类型：</span>
											<select id="type" name="type" class="organ-info cenz check_inp check_inps" >
				                                    <option value="">全部</option>
				                                    <option <?php if($info['type']==1): ?>selected="selected"<?php endif; ?> value="1">安装</option>
				                                    <option <?php if($info['type']==2): ?>selected="selected"<?php endif; ?> value="2">拆除</option>
				                            </select>
										</label>
									</div>
								</div>
							</div>
							<div class="equip_list engin_boxt clearfix row">
								<div class="col-md-6">
									<div class="cheitm">
										<label class="ifro_item">
											<span class="info_man engin_span">设备安装位置：</span>
											<input type="text" id="address" name="address" value="{$info.address}" class="check_inp" placeholder=" 输入设备安装位置" />
										</label>
									</div>
								</div>

							</div>
						</div>
						</div>
				</div><!--equip_infomation-->
			<!--工程信息-->
			<div class="equip_info equip_infot">
				<div class="equip_title engin_title">
					<i class="equip_i"></i>
					<span>工程信息</span>
				</div>
				<div class="equip_infomation">
					<!--基本工程信息编辑-->
						<div class="detail-body engin_edit_box clearfix">
							<div class="equip_list engin_boxt clearfix row">
								<div class="col-md-6">
									<div class="cheitm">
										<label class="ifro_item">
											<span class="info_man engin_span">工程名称：</span>
											<select id="e_id" name="e_id" class="check_inp chosen-select" >
												<option value="">请选择工程名称</option>
												<?php foreach($engin as $k=>$v){ ?>
												<?php if($v['id'] == $info['e_id']): ?>
												<option selected="selected" value="{$v.id}">{$v.name}</option>
												<?php else: ?>
												<option value="{$v.id}">{$v.name}</option>
												<?php endif; ?>
												<?php } ?>

											</select>
										</label>
									</div>
								</div>
								<div class="col-md-6">
									<div class="cheitm">
										<label class="ifro_item">
											<span class="info_man engin_span">工程编号：</span>
											<span id="engin_code" class="check_inp check_inp_span">{$info.engin_code}</span>
										</label>
									</div>
								</div>
							</div>
							<div class="equip_list engin_boxt clearfix row">
								<div class="col-md-6">
									<div class="cheitm">
										<label class="ifro_item">
											<span class="info_man engin_span">工程地址：</span>
											<span id="engin_address" class="check_inp check_inp_span">{$info.diqu}</span>
										</label>
									</div>
								</div>
								<!--<div class="col-md-6">-->
									<!--<div class="cheitm">-->
										<!--<label class="ifro_item">-->
											<!--<span class="info_man engin_span">监督验证证号：</span>-->
											<!--<span class="check_inp check_inp_span">LANG-1705-02</span>-->
										<!--</label>-->
									<!--</div>-->
								<!--</div>-->
							</div>
							<!--<div class="equip_list engin_boxt clearfix row">-->
								<!--<div class="col-md-6">-->
									<!--<div class="cheitm">-->
										<!--<label class="ifro_item">-->
											<!--<span class="info_man engin_span">制造许可证编号：</span>-->
											<!--<span class="check_inp check_inp_span">FDGTFRH657687</span>-->
										<!--</label>-->
									<!--</div>-->
								<!--</div>	-->
							<!--</div>	-->
						</div>
						</div>
				</div><!--equip_infomation-->
			<!--施工信息-->
			<div class="equip_info equip_infot">
				<div class="equip_title engin_title">
					<i class="equip_i"></i>
					<span>施工信息</span>
				</div>
				<div class="equip_infomation">
					<!--基本工程信息编辑-->
						<div class="detail-body engin_edit_box clearfix">
							<div class="equip_list engin_boxt clearfix row">
								<div class="col-md-6">
									<div class="cheitm">
										<label class="ifro_item">
											<span class="info_man engin_span">施工单位：</span>
											<select id="c_id" name="c_id" class="check_inp chosen-select" >
												<option value="">请选择施工单位</option>
												<?php foreach($company as $k=>$v){ ?>
												<?php if($v['id'] == $info['c_id']): ?>
												<option selected="selected" value="{$v.id}">{$v.name}</option>
												<?php else: ?>
												<option value="{$v.id}">{$v.name}</option>
												<?php endif; ?>
												<?php } ?>

											</select>
										</label>
									</div>
								</div>
								<div class="col-md-6">
									<div class="cheitm">

										<label class="ifro_item">
											<span class="info_man engin_span">施工时间：</span>
											<input id="work_time" onclick="laydate()" value="{$info.work_time}" name="work_time"  placeholder='年-月-日' value="" class="fl check_inp check_inp_date picker-date">
										</label>
									</div>
								</div>
							</div>
							<!--<div class="equip_list engin_boxt clearfix row">-->
								<!--<div class="col-md-6">-->
									<!--<div class="cheitm">-->
										<!--<label class="ifro_item">-->
											<!--<span class="info_man engin_span">施工单位地址：</span>-->
											<!--<span class="check_inp check_inp_span">FDGTFRH657687</span>-->
										<!--</label>-->
									<!--</div>-->
								<!--</div>	-->
							<!--</div>-->
						</div>
						</div>
				</div><!--equip_infomation-->
			<!--资料核查-->
			<div class="equip_info equip_infot">
				<div class="equip_title engin_title">
					<i class="equip_i"></i>
					<span>资料核查</span>
				</div>
				<div class="equip_infomation">
					<!--设备参数表格-->
						<div class="detail-body engin_edit_box clearfix">
							<div class="table">
								<table class="layui-table fac_table" lay-skin="line">
									<thead>
										<tr>
											<th>序号</th>
											<th></th>
											<th>申报材料名称</th>
											<th>文件</th>
											<th>删除</th>
										</tr>
									</thead>
									<tbody class="fac_tbody">
									<?php foreach($info['param'] as $k=>$v){ ?>
										<tr class="fac_edittr ziliao">
											<td>{$k+1}</td>
											<td><input name="p_id[]" type="hidden" value="{$v.id}" class="fac_edittr_input " /></td>
											<td><input name="p_name[]" type="text" value="{$v.name}" class="fac_edittr_input p_name" /></td>
											<td>
												<label class="ifro_item id_relative">
													<input name="p_file{$k+1}" type="file" class="up_file p_file" />
													<!--<span class="idcardupload">更改文件</span>-->
													</label>
												</td>
											<td data="{$v.id}" class="del_edittim"><i class="del_edits" id="detail_del"></i></td>
										</tr>
									<?php } ?>
									</tbody>
								</table>
							</div>
						</div>
					<!--完成-->
					<div class="add_finish equip_finish">
						<a class="datas_add">
				    		<i class="engin_add"></i>
				    		<span class="engin_add_text" id="new_builds">新建申报材料</span>
				    	</a>
					</div>
				</div><!--equip_infomation-->
			</div>		
			<!--作业人员登记-->
			<div class="equip_info equip_infot">
				<div class="equip_title engin_title">
					<i class="equip_i"></i>
					<span>作业人员登记</span>
				</div>
				<div class="equip_infomation" style="padding-bottom:20px !important ;">
					<!--设备参数表格-->
						<div class="detail-body engin_edit_box clearfix">
							<div class="table">
								<table class="layui-table fac_table1" lay-skin="line">
									<thead>
										<tr>
											<th>序号</th>
											<th>姓名</th>
											<th>岗位</th>
											<th>身份证号</th>
											<th>手机号</th>
											<th>删除</th>
										</tr>
									</thead>
									<tbody class="fac_tbody">
									<?php foreach($info['oper'] as $k=>$v){ ?>
										<tr class="fac_edittr oper">
											<td>{$k+1}<input type="hidden" name="o_id[]" value="{$v.id}" class="fac_edittr_input"  /></td>
											<td><input type="text" name="o_name[]" value="{$v.name}" class="fac_edittr_input o_name" placeholder="输入人员姓名"  /></td>
											<td><input type="text" name="o_gangwei[]" value="{$v.gangwei}" class="fac_edittr_input o_gangwei" placeholder="输入人员岗位"  /></td>
											<td><input type="text" name="o_IDcard[]" value="{$v.IDcard}" class="fac_edittr_input o_IDcard" placeholder="输入身份证号"  /></td>
											<td><input type="text" name="o_mobile[]" value="{$v.mobile}" class="fac_edittr_input o_mobile" placeholder="输入手机号"  /></td>
											<td data="{$v.id}" class="del_oper"><i class="del_edits" id="detail_del"></i></td>
										</tr>
									<?php } ?>
									</tbody>
								</table>
						</div>
				</div>
					<!--完成-->
					<div class="add_finish equip_finish">
						<a class="datas_add">
				    		<i class="engin_add"></i>
				    		<span class="engin_add_text" id="new_oper">新建作业人员</span>
				    	</a>
					</div>
			<!--审核登记-->
			<form class="equip_info equip_infot" style="padding: ;">
				<div class="equip_title engin_title">
					<i class="equip_i"></i>
					<span>审核登记</span>
				</div>
				<div class="equip_infomation">
					<!--基本工程信息编辑-->
						<div class="detail-body engin_edit_box clearfix">
							<div class="equip_list engin_boxt clearfix row">
								<div class="col-md-6">
									<div class="cheitm">
										<label class="ifro_item">
											<span class="info_man engin_span">备案审核结果：</span>
											 <select name="beian_status" id="beian_status" class="organ-info cenz check_inp check_inps" >
			                                    <option value="">全部</option>
			                                    <option <?php if($info['beian_status']==1): ?>selected="selected"<?php endif; ?> value="1">已审核</option>
			                                    <option <?php if($info['beian_status']==2): ?>selected="selected"<?php endif; ?> value="2">未审核</option>
			                                </select>
										</label>
									</div>
								</div>
								<div class="col-md-6">
									<div class="cheitm">
										<label class="ifro_item">
											<span class="info_man engin_span">备案日期：</span>
											<input id="beian_time" onclick="laydate()" value="{$info.beian_time}" name="beian_time"  placeholder='年-月-日' value="" class="fl check_inp picker-date">
										</label>
									</div>
								</div>
								<div class="col-md-6">
									<div class="cheitm">
										<label class="ifro_item id_relative" style="margin-top:14px ;">
											<span class="info_man engin_span" style="line-height: 26px;">附件：</span>
											<input type="file" id="file" name="file" class="up_file up_files" title="文件不大于5M" />
											<!--<span class="idcardupload">选择文件</span>-->
										</label>
									</div>
								</div>
							</div>
						</div>
				</div>
				
				<!--完成-->
				<div class="add_finish equip_finish">
					<a href="javascript:0" id="save" class="opass equipfinish engin_finish">保存</a>
					<a onclick="javascript:history.go(-1);" class="opass equipfinish engin_finish_exit">取消</a>
				</div>
			</form>
		
	</div>		
<!--content-->

<script src="__PUBLIC__/assets/js/laydate/laydate.js"></script>
<include file="Public:footer"/>
<script>


	$(document).on('click','#save',function(){
		var r_id = $('#r_id').val();
		var f_id = $('#f_id').val();
		var code = $('#code').val();
		var address = $('#address').val();
		var type = $('#type').val();
		var e_id = $('#e_id').val();
		var c_id = $('#c_id').val();
		var work_time = $('#work_time').val();
		var beian_status = $('#beian_status').val();
		var beian_time = $('#beian_time').val();

		if(r_id == '' ){
			layer.msg('产权备案编号不能为空', {time: 1500});
			return false;
		}

		if(code == '' ){
			layer.msg('安拆告知编号不能为空', {time: 1500});
			return false;
		}

		if(address == '' ){
			layer.msg('设备安装位置不能为空', {time: 1500});
			return false;
		}

		if(type == '' ){
			layer.msg('安拆类型不能为空', {time: 1500});
			return false;
		}

		if(e_id == '' ){
			layer.msg('工程名称不能为空', {time: 1500});
			return false;
		}

		if(c_id == '' ){
			layer.msg('施工单位不能为空', {time: 1500});
			return false;
		}


		var is_null = 0;
		$('.p_name').each(function(){

			if($(this).val()==''){
				is_null++;
			}
		})

		if(is_null>0){
			layer.msg('申报材料名称不能为空', {time: 1500});
			return false;
		}


		<?php if(ACTION_NAME=='install_add'): ?>
		var is_null = 0;
		$('.p_file').each(function(){

			if($(this).val()==''){
				is_null++;
			}
		})

		if(is_null>0){
			layer.msg('申报材料文件不能为空', {time: 1500});
			return false;
		}
		<?php endif; ?>

		var is_null = 0;
		$('.o_name').each(function(){

			if($(this).val()==''){
				is_null++;
			}
		})

		if(is_null>0){
			layer.msg('姓名不能为空', {time: 1500});
			return false;
		}

		var is_null = 0;
		$('.o_gangwei').each(function(){

			if($(this).val()==''){
				is_null++;
			}
		})

		if(is_null>0){
			layer.msg('岗位不能为空', {time: 1500});
			return false;
		}

		var is_null = 0;
		$('.o_IDcard').each(function(){

			if($(this).val()==''){
				is_null++;
			}
		})

		if(is_null>0){
			layer.msg('身份证号不能为空', {time: 1500});
			return false;
		}

		var is_null = 0;
		$('.o_mobile').each(function(){

			if($(this).val()==''){
				is_null++;
			}
		})

		if(is_null>0){
			layer.msg('手机号不能为空', {time: 1500});
			return false;
		}





		if(work_time == '' ){
			layer.msg('施工时间不能为空', {time: 1500});
			return false;
		}

		if(beian_status == '' ){
			layer.msg('备案审核结果不能为空', {time: 1500});
			return false;
		}

		if(beian_time == '' ){
			layer.msg('备案审核时间不能为空', {time: 1500});
			return false;
		}

		if(beian_time>work_time){
			layer.msg('备案审核时间不能晚于施工时间', {time: 1500});
			return false;
		}

		layer.load(1, {
			shade: [0.1,'#fff'] //0.1透明度的白色背景
		});

		$('#form1').ajaxSubmit({
			dataType:'json',
			success:function(res){
				layer.closeAll();
				if(res.status !=1){
					layer.msg(res.msg, {time: 1500});
					return false;
				}else{

					layer.closeAll();
					layer.msg(res.msg, {time: 1500},function(){
						javascript:history.go(-1);
					});

				}
			}
		});


	})

	$(document).on('change','#r_id',function(){

		var id = $(this).val();
		if(id==''){
			$('#chanquan_company').text('');
			$('#f_id').val('');
			$('#fac_code').text('');
			$('#fac_type').text('');
			$('#fac_xinghao').text('');
			$('#fac_chuchang').text('');
			return false;
		}

		layer.load(1, {
			shade: [0.1,'#fff'] //0.1透明度的白色背景
		});

		$.ajax({
			url:"{:U('Admin/File/')}"+'/'+"{:ACTION_NAME}",
			dataType:'json',
			type:'post',
			data:{
				'do':'get_record',
				'id':id
			},
			success:function(e){
				layer.closeAll();
				if(e.status!=1){
					layer.msg('获取产权信息失败，请重试', {time: 1500});
					return false;
				}

				$('#chanquan_company').text(e.data.name);
				$('#f_id').val(e.data.id);
				$('#fac_code').text(e.data.facility_number);
				$('#fac_type').text(e.data.facility_type);
				$('#fac_xinghao').text(e.data.facility_model_number);
				$('#fac_chuchang').text(e.data.factory_date);

				return false;

			}
		})
	})


	$(document).on('change','#e_id',function(){

		var id = $(this).val();
		if(id==''){
			$('#engin_code').text('');
			$('#engin_address').text('');
			return false;
		}

		layer.load(1, {
			shade: [0.1,'#fff'] //0.1透明度的白色背景
		});

		$.ajax({
			url:"{:U('Admin/File/')}"+'/'+"{:ACTION_NAME}",
			dataType:'json',
			type:'post',
			data:{
				'do':'get_engin',
				'id':id
			},
			success:function(e){
				layer.closeAll();
				if(e.status!=1){
					layer.msg('获取产权信息失败，请重试', {time: 1500});
					return false;
				}


				$('#engin_code').text(e.data.code);
				$('#engin_address').text(e.data.diqu);

				return false;

			}
		})
	})


	$(document).on('click','.fac_table tr .del_edittim',function(){
		if($(this).attr('data')==0){

		}else{
			var id = $(this).attr('data');
			layer.load(1, {
				shade: [0.1,'#fff'] //0.1透明度的白色背景
			});
			$.ajax({
				url:"{:U('Admin/File/install_edit')}",
				dataType:'json',
				type:'post',
				data:{
					'do':'del_param',
					'id':id

				},
				success:function(e){
					layer.closeAll();
					layer.msg(e.msg, {time: 1500});
					if(e.status ==1){
						$(this).parent().remove();
					}

				}
			})
		}
		$(this).parent().remove();
		return false;
	})

	$(document).on('click','.del_oper',function(){
		if($(this).attr('data')==0){

		}else{
			var id = $(this).attr('data');
			layer.load(1, {
				shade: [0.1,'#fff'] //0.1透明度的白色背景
			});
			$.ajax({
				url:"{:U('Admin/File/install_edit')}",
				dataType:'json',
				type:'post',
				data:{
					'do':'del_oper',
					'id':id

				},
				success:function(e){
					layer.closeAll();
					layer.msg(e.msg, {time: 1500});
					if(e.status ==1){

					}

				}
			})
		}
		$(this).parent().remove();
		return false;
	})
	$(document).on('click','#new_builds',function(){
		var num = 1;
		$('.ziliao').each(function(){
			num++;
		})

		var fac_html=	'<tr class="fac_edittr ziliao">'+
							'<td>'+num+'</td>'+
							'<td><input name="p_id[]" type="hidden" class="fac_edittr_input " /></td>'+
							'<td><input name="p_name[]" type="text" class="fac_edittr_input p_name" /></td>'+
							'<td>'+
							'<label class="ifro_item id_relative">'+
							'<input name="p_file'+num+'" type="file" class="up_file p_file" title="文件不大于5M" />'+
//							'<span class="idcardupload">选择文件</span>'+
							'</label>'+
							'</td>'+
							'<td data="0" class="del_edittim"><i class="del_edits" id="detail_del"></i></td>'+
						'</tr>';
		$('.fac_table .fac_tbody').append(fac_html);
	})

	$(document).on('click','#new_oper',function(){
		var num = 1;
		$('.oper').each(function(){
			num++;
		})

		var fac_html=	'<tr class="fac_edittr oper">'+
							'<td>'+num+'<input type="hidden" name="o_id[]" class="fac_edittr_input"  /></td>'+
							'<td><input type="text" name="o_name[]" class="fac_edittr_input o_name" placeholder="输入人员姓名"  /></td>'+
							'<td><input type="text" name="o_gangwei[]" class="fac_edittr_input o_gangwei" placeholder="输入人员岗位"  /></td>'+
							'<td><input type="text" name="o_IDcard[]" class="fac_edittr_input o_IDcard" placeholder="输入身份证号"  /></td>'+
							'<td><input type="text" name="o_mobile[]" class="fac_edittr_input o_mobile" placeholder="输入手机号"  /></td>'+
							'<td data="0" class="del_oper"><i class="del_edits" id="detail_del"></i></td>'+
						'</tr>';
		$('.fac_table1 .fac_tbody').append(fac_html);
	})


	window.onload=function(){

		$('.chosen-single').css('background-color','rgba(51,51,51,0.1)');
		$('.chosen-container-single').css('margin-left','13px');
	}
</script>