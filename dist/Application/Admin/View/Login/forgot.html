<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>{$title}</title>
    <link rel="stylesheet" href="/Public/assets/css/login/reset.css">
    <link rel="stylesheet" href="/Public/assets/css/login/common.css">
</head>
<body>
<div class="login_back">
    <div class="middle_content_block">
        <div class="content">
            <div class="title">
                <h1>飞达建筑起重机械</h1>
                <span>安全监管物联网平台</span>
            </div>
            <!--shoujihao-->
            <div id="person_user" class="detail_content forget_child" >
                <form action="{:U('Admin/Login/forgot')}" method="post" id="form1">
                    <input type="hidden" name="do" value="check" >
                    <div class="login_welcome">
                        <span>找回密码</span>
                    </div>
                    <div class="process_img process_item_forget">
                        <div>
                            <img src="/Public/assets/images/login/forget_view1.png" alt="">
                        </div>
                        <b></b>
                        <div>
                            <img src="/Public/assets/images/login/forget2.png" alt="">
                        </div>
                        <b></b>
                        <div>
                            <img src="/Public/assets/images/login/forget3.png" alt="">
                        </div>
                    </div>
                    <div class="login_block">
                        <label for="person_phone">
                            <b class="person_phone"></b> <input  type="text" name="mobile" id="person_phone" placeholder="请输入手机号获取验证码">
                            <!--<p class="check_warn"><img src="/Public/assets/images/login/warn_icon.png" alt=""> <span>号码输入有误,请重新输入</span></p>-->
                        </label>
                        <div class="center_code_container">
                            <b class="code_icon"></b>
                            <input type="text" id="phone_code" name="code" placeholder="请输入验证码">
                            <div class="phone_code_set">
                                <button id="phone_give_pass">获取验证码</button>
                            </div>
                        </div>
                        <input id="forget_check"   type="submit" value="提交">
                        <p class="miss_pass">记起密码 <a href="index.html">立即登录</a></p>
                    </div>
                </form>
            </div>
            <!--new_password-->
            <div style="display: none;" id="new_password" data-code="forget_check" class="detail_content forget_child">
                <form action="{:U('Admin/Login/forgot')}" id="form2" method="post">
                    <input type="hidden" name="do" value="change_pwd">
                    <input type="hidden" name="mobile" id="user_mobile">
                    <div class="login_welcome">
                        <span>找回密码</span>
                    </div>
                    <div class="process_img">
                        <div>
                            <img src="/Public/assets/images/login/forget1.png" alt="">
                        </div>
                        <b></b>
                        <div>
                            <img src="/Public/assets/images/login/forget_view2.png" alt="">
                        </div>
                        <b></b>
                        <div>
                            <img src="/Public/assets/images/login/forget3.png" alt="">
                        </div>
                    </div>
                    <div class="set_new_pass login_block">
                        <label>
                            <b class="password_icon" ></b>
                            <input type="password" name='pwd1' maxlength="20" id="pwd1" placeholder="请输入6位以上字符密码">
                        </label>
                        <label>
                            <b class="password_icon"></b>
                            <input type="password" name='pwd2' maxlength="20" id="pwd2" placeholder="再次输入">
                        </label>
                        <input id="new_password_build" type="submit" value="确定">
                        <div class="h100"></div>
                    </div>
                </form>
            </div>
            <!--success-->
            <div style="display: none;"  data-code="new_password_build"  id="success_page" class="detail_content forget_child">
                <form action="#">
                    <div class="login_welcome">
                        <span>找回密码</span>
                    </div>
                    <div class="success_alert">
                        <div>
                            <p class="icon_alert">
                                <span>恭喜您!</span>
                                <span>密码重置已完成!</span>
                            </p>
                            <a class="come_login_btn" href="index.html">重新登录</a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<script src="/Public/assets/js/jquery-2.1.1.js"></script>

<script src="__PUBLIC__/assets/plugins/jquery/jquery-1.9.1.min.js"></script>
<script src="__PUBLIC__/assets/plugins/jquery/jquery-migrate-1.1.0.min.js"></script>
<script src="__PUBLIC__/assets/plugins/jquery-ui/ui/minified/jquery-ui.min.js"></script>
<script src="__PUBLIC__/assets/plugins/bootstrap/js/bootstrap.min.js"></script>
<!--[if lt IE 9]>
<script src="assets/crossbrowserjs/html5shiv.js"></script>
<script src="assets/crossbrowserjs/respond.min.js"></script>
<script src="assets/crossbrowserjs/excanvas.min.js"></script>
<![endif]-->
<script src="__PUBLIC__/assets/plugins/slimscroll/jquery.slimscroll.min.js"></script>
<script src="__PUBLIC__/assets/plugins/jquery-cookie/jquery.cookie.js"></script>
<!-- ================== END BASE JS ================== -->

<!-- ================== BEGIN PAGE LEVEL JS ================== -->
<script src="__PUBLIC__/assets/js/apps.min.js"></script>
<!-- ================== END PAGE LEVEL JS ================== -->
<js file="__PUBLIC__/assets/js/nice-validator-0.8.1/jquery.validator.js"/>
<js file="__PUBLIC__/assets/js/nice-validator-0.8.1/local/zh-CN.js"/>
<css file="__PUBLIC__/assets/js/nice-validator-0.8.1/jquery.validator.css"/>
<js file="__PUBLIC__/assets/js/layer/layer.js"/>
<js file="__PUBLIC__/assets/js/jquery.form.js" />
<script>
    //验证通过切换到重新设置密码
    $('#forget_check').click(function(){
        var phone = $('#person_phone').val();
        if(phone==''){
            layer.msg('请填写手机号', {time: 1500});
            return false;
        }

        var pattern = /^1[34578]\d{9}$/;

        if(pattern.test(phone)==false){
            layer.msg('手机号码格式不正确', {time: 1500});
            return false;
        }

        var code = $('#phone_code').val();
        if(code == ''){
            layer.msg('验证码不能为空', {time: 1500});
            return false;
        }
        layer.load(1, {
            shade: [0.1,'#000'] //0.1透明度的白色背景
        });

        $('#form1').ajaxSubmit({
            dataType:'json',
            success:function(res){
                layer.closeAll();
                if(res.status !=1){
                    layer.confirm(res.msg, {
                        btn: ['确定'], //按钮
                        closeBtn:0
                    }, function() {
                        layer.closeAll();
                        // $('#username,#password,#verify').val('')
//                        window.location.reload();
                    });
                } else {

                    layer.msg('验证成功', {time: 1500});
                    var str=$('#forget_check').attr('id');
                    $('.forget_child').slideUp();
                    $('div[data-code='+str+']').slideDown();
                    $('#user_mobile').val(phone);

                }
            }
        });
        return false;


    })
    //显示成功
    $('#new_password_build').click(function(){
        var pwd1 = $('#pwd1').val();


        if(pwd1.length < 6){
            layer.msg('密码长度至少为6位', {time: 1500});
            return false;
        }

        var jiancha = /[\u4e00-\u9fa5]/g;

        if(jiancha.test(pwd1)){
            layer.msg('密码不能包含中文', {time: 1500});
            return false;
        }

        var pwd2 = $('#pwd2').val();
        if(pwd2 == ''){
            layer.msg('请确认密码', {time: 1500});
            return false;
        }

        if(pwd2 != pwd1){
            layer.msg('两次密码输入不一致', {time: 1500});
            return false;
        }

        layer.load(1, {
            shade: [0.1,'#000'] //0.1透明度的白色背景
        });

        $('#form2').ajaxSubmit({
            dataType:'json',
            success:function(res){
                layer.closeAll();
                if(res.status !=1){
                    layer.confirm(res.msg, {
                        btn: ['确定'], //按钮
                        closeBtn:0
                    }, function() {
                        layer.closeAll();
                        // $('#username,#password,#verify').val('')
//                        window.location.reload();
                    });
                } else {

                    layer.msg('验证成功', {time: 1500});
                    var str=$('#new_password_build').attr('id');
                    $('.forget_child').slideUp();
                    $('div[data-code='+str+']').slideDown();

                }
            }
        });
        return false;




    })
//    获取验证码动画
    var giveCheckCode={
        num:60,
        timeSet:'',
        init:function(){
            var _this=this;
            $(document).on('click','#phone_give_pass',function(e){
                var phone = $('#person_phone').val();

                if(phone==''){
                    layer.msg('请填写手机号', {time: 1500});
                    return false;
                }
                var pattern = /^1[34578]\d{9}$/;

                if(pattern.test(phone)==false){
                    layer.msg('手机号码格式不正确', {time: 1500});
                    return false;
                }

                layer.load(1, {
                    shade: [0.1,'#000'] //0.1透明度的白色背景
                });

                e.preventDefault();
                $(this).addClass('phone_give_pass_move');
                _this.resetMove(this);

                $.ajax({
                    url:"{:U('Admin/Login/forgot')}",
                    dataType:'json',
                    type:'post',
                    data:{
                        do:'send',
                        mobile :phone
                    },
                    success:function(res){
                        if(res.status !=1){
                            layer.closeAll();
                            layer.confirm(res.msg, {
                                btn: ['确定'], //按钮
                                closeBtn:0
                            }, function() {
                                layer.closeAll();
//                                // $('#username,#password,#verify').val('')
//                                window.location.reload();
                            });
                        } else {
                            layer.closeAll();
                            _this.waitTime();
                            $(this).prop('disabled',true);
                        }
                    }
                });


            })
        },
        resetMove:function(now){
            setTimeout(function(){
                $(now).removeClass('phone_give_pass_move');
            },600);
        },
        waitTime:function(){
            this.timeSet=setInterval(function(){
                this.num--;
                $('#phone_give_pass').html('('+this.num+'s)重新发送')
                if(this.num<=0){
                    clearInterval(this.timeSet);
                    $('#phone_give_pass').html('获取验证码');
                    $('#phone_give_pass').prop('disabled',false);
                    this.num=60;
                }
            }.bind(this),1000);
        }
    }
    window.onload=function(){
        giveCheckCode.init();
        $('#phone_give_pass').prop('disabled',false);
        $('body').addClass('set_come');
        //$('body').css('height',$(window).height());
    }

</script>
</body>
</html>